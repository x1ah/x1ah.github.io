<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Elasticsearch on x1ah</title>
    <link>https://when.run/tags/elasticsearch/</link>
    <description>Recent content in Elasticsearch on x1ah</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    <lastBuildDate>Tue, 02 Mar 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://when.run/tags/elasticsearch/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>å¦‚ä½•å¹³ç¨³çš„å°† Elasticsearch 5.x é›†ç¾¤è¿ç§»åˆ° Elasticsearch 7.x</title>
      <link>https://when.run/posts/elasticsearch-upgrade/</link>
      <pubDate>Tue, 02 Mar 2021 00:00:00 +0000</pubDate>
      
      <guid>https://when.run/posts/elasticsearch-upgrade/</guid>
      <description>èƒŒæ™¯ å…¬å¸çš„å†…å®¹æœç´¢ä¸šåŠ¡ä¸»è¦åŸºäº Elasticsearch åšçš„ï¼Œè€é›†ç¾¤å·²ç»æœ‰äº”å…­å¹´çš„å†å²ï¼Œç‰ˆæœ¬åœç•™åœ¨äº† 5.6, é›†ç¾¤å†…çš„ document æ•°çº¦æœ‰ 20 äº¿çš„è§„æ¨¡ï¼Œç£ç›˜å ç”¨ä¸åˆ° 500 GBã€‚
éœ€è¦å‡çº§åˆ°æ–°ç‰ˆæœ¬ es çš„ä¸»è¦åŸå› æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š
 å‰æ®µæ—¶é—´å¶å‘æ€§çš„é›†ç¾¤æ•…éšœï¼Œå¯¼è‡´å´©æºƒï¼Œæ’æŸ¥å‘ç°ç–‘ä¼¼ç‰ˆæœ¬ bug Elasticsearch 7.x å¸¦æ¥äº†ä¸€ç³»åˆ—ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ€§èƒ½æœ‰ä¸å°çš„æå‡  å‡çº§æ–¹æ¡ˆè°ƒç ” Rolling upgrades  å®˜æ–¹æ–‡æ¡£ï¼šrolling upgrades
 ç”±äºæ—§é›†ç¾¤ç‰ˆæœ¬ä¸º 5.x ï¼Œéœ€è¦å‡çº§åˆ°çš„ç‰ˆæœ¬ä¸º 7.xï¼Œä¸­é—´æ¨ªè·¨ä¸¤ä¸ªå¤§ç‰ˆæœ¬ï¼Œæ ¹æ® elastic å®˜æ–¹å»ºè®®çš„å‡çº§ rolling upgrade æ­¥éª¤ï¼Œä¸­é—´éœ€è¦ä¸¤æ¬¡ rolling upgradeï¼Œåˆ†åˆ«ä¸ºï¼š
 From 5.x to 5.6 From 5.6 to 6.8 (rolling upgrade) From 6.8 to 7.x (rolling upgrade)  å‡çº§è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦ç»™é›†ç¾¤è®¾ç½®ä¸€å †é€‰é¡¹ï¼Œè¿™ä¸ªè¿‡ç¨‹çœ‹ä¼¼å¾ˆå¹³æ»‘ï¼Œè²Œä¼¼å¯ä»¥åšåˆ° graceful shutdownï¼Œä½†æ˜¯å®é™…æ˜¯ä¸å¯é€†çš„ï¼Œä¸­é—´ä»»ä½•ä¸€ä¸ªæ­¥éª¤å‡ºé”™éƒ½å¾ˆéš¾ç«‹é©¬æ¢å¤åˆ°å‡çº§å‰çš„çŠ¶æ€ã€‚æœç´¢æœåŠ¡éœ€è¦é«˜å¯ç”¨ï¼Œè€Œè¿™äº›æ“ä½œéƒ½æ˜¯ç›´æ¥å¯¹çº¿ä¸Šé›†ç¾¤è¿›è¡Œæ“ä½œï¼Œé£é™©æå¤§ï¼Œä¸€ä¸å°å¿ƒå¯èƒ½ä¼šå¯¼è‡´é›†ç¾¤æ•…éšœã€‚å› æ­¤è¿™ä¸ªå‡çº§æ–¹æ¡ˆä¸å¯è¡Œã€‚
æ–°é›†ç¾¤ &amp;amp; æ–°ç´¢å¼• é™¤äº†å¯¹åŸé›†ç¾¤ rolling upgradeï¼Œè¿˜æœ‰ä¸€ç§ä¸‡æ— ä¸€å¤±çš„å‡çº§æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ç›´æ¥å¼€å¯ä¸€ä¸ª Elasticsearch 7.x ç‰ˆæœ¬çš„æ–°é›†ç¾¤ï¼Œé›†ç¾¤ ready ä¹‹åï¼Œå†æŠŠè€çš„ç´¢å¼•é‡å»ºåˆ°æ–°é›†ç¾¤ã€‚ä¸€åˆ‡å‡†å¤‡å¥½ä¹‹åï¼Œè¿˜å¯ä»¥è¿›è¡Œå‹æµ‹ï¼Œå¯¹æ¯”æ€§èƒ½ã€æ•°æ®å·®å¼‚ï¼Œå¹¶ä¸”å…¨ç¨‹ä¸å½±å“æœåŠ¡çš„å¯ç”¨æ€§ã€‚å…·ä½“å‡çº§æµç¨‹å¦‚ä¸‹ï¼š</description>
      <content>&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;å…¬å¸çš„å†…å®¹æœç´¢ä¸šåŠ¡ä¸»è¦åŸºäº Elasticsearch åšçš„ï¼Œè€é›†ç¾¤å·²ç»æœ‰äº”å…­å¹´çš„å†å²ï¼Œç‰ˆæœ¬åœç•™åœ¨äº† 5.6, é›†ç¾¤å†…çš„ document æ•°çº¦æœ‰ 20 äº¿çš„è§„æ¨¡ï¼Œç£ç›˜å ç”¨ä¸åˆ° 500 GBã€‚&lt;/p&gt;
&lt;p&gt;éœ€è¦å‡çº§åˆ°æ–°ç‰ˆæœ¬ es çš„ä¸»è¦åŸå› æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å‰æ®µæ—¶é—´å¶å‘æ€§çš„é›†ç¾¤æ•…éšœï¼Œå¯¼è‡´å´©æºƒï¼Œæ’æŸ¥å‘ç°ç–‘ä¼¼ç‰ˆæœ¬ bug&lt;/li&gt;
&lt;li&gt;Elasticsearch 7.x å¸¦æ¥äº†ä¸€ç³»åˆ—ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ€§èƒ½æœ‰ä¸å°çš„æå‡&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å‡çº§æ–¹æ¡ˆè°ƒç ”&#34;&gt;å‡çº§æ–¹æ¡ˆè°ƒç ”&lt;/h2&gt;
&lt;h4 id=&#34;rolling-upgrades&#34;&gt;Rolling upgrades&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/rolling-upgrades.html&#34;&gt;rolling upgrades&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç”±äºæ—§é›†ç¾¤ç‰ˆæœ¬ä¸º 5.x ï¼Œéœ€è¦å‡çº§åˆ°çš„ç‰ˆæœ¬ä¸º 7.xï¼Œä¸­é—´æ¨ªè·¨ä¸¤ä¸ªå¤§ç‰ˆæœ¬ï¼Œæ ¹æ® elastic å®˜æ–¹å»ºè®®çš„å‡çº§ &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/rolling-upgrades.html&#34;&gt;rolling upgrade&lt;/a&gt; æ­¥éª¤ï¼Œä¸­é—´éœ€è¦ä¸¤æ¬¡ rolling upgradeï¼Œåˆ†åˆ«ä¸ºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;From 5.x to 5.6&lt;/li&gt;
&lt;li&gt;From 5.6 to 6.8 (&lt;strong&gt;rolling upgrade&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;From 6.8 to 7.x (&lt;strong&gt;rolling upgrade&lt;/strong&gt;)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å‡çº§è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦ç»™é›†ç¾¤è®¾ç½®ä¸€å †é€‰é¡¹ï¼Œè¿™ä¸ªè¿‡ç¨‹çœ‹ä¼¼å¾ˆå¹³æ»‘ï¼Œè²Œä¼¼å¯ä»¥åšåˆ° graceful shutdownï¼Œä½†æ˜¯å®é™…æ˜¯ä¸å¯é€†çš„ï¼Œä¸­é—´ä»»ä½•ä¸€ä¸ªæ­¥éª¤å‡ºé”™éƒ½å¾ˆéš¾ç«‹é©¬æ¢å¤åˆ°å‡çº§å‰çš„çŠ¶æ€ã€‚æœç´¢æœåŠ¡éœ€è¦é«˜å¯ç”¨ï¼Œè€Œè¿™äº›æ“ä½œéƒ½æ˜¯ç›´æ¥å¯¹çº¿ä¸Šé›†ç¾¤è¿›è¡Œæ“ä½œï¼Œé£é™©æå¤§ï¼Œä¸€ä¸å°å¿ƒå¯èƒ½ä¼šå¯¼è‡´é›†ç¾¤æ•…éšœã€‚å› æ­¤è¿™ä¸ªå‡çº§æ–¹æ¡ˆä¸å¯è¡Œã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ–°é›†ç¾¤--æ–°ç´¢å¼•&#34;&gt;æ–°é›†ç¾¤ &amp;amp; æ–°ç´¢å¼•&lt;/h4&gt;
&lt;p&gt;é™¤äº†å¯¹åŸé›†ç¾¤ rolling upgradeï¼Œè¿˜æœ‰ä¸€ç§ä¸‡æ— ä¸€å¤±çš„å‡çº§æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ç›´æ¥å¼€å¯ä¸€ä¸ª Elasticsearch 7.x ç‰ˆæœ¬çš„æ–°é›†ç¾¤ï¼Œé›†ç¾¤ ready ä¹‹åï¼Œå†æŠŠè€çš„ç´¢å¼•é‡å»ºåˆ°æ–°é›†ç¾¤ã€‚ä¸€åˆ‡å‡†å¤‡å¥½ä¹‹åï¼Œè¿˜å¯ä»¥è¿›è¡Œå‹æµ‹ï¼Œå¯¹æ¯”æ€§èƒ½ã€æ•°æ®å·®å¼‚ï¼Œå¹¶ä¸”å…¨ç¨‹ä¸å½±å“æœåŠ¡çš„å¯ç”¨æ€§ã€‚å…·ä½“å‡çº§æµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ­å»ºæ–°é›†ç¾¤ï¼Œå°½é‡ä¿æŒé…ç½®ä¸è€é›†ç¾¤ä¸€è‡´ã€‚æ¯”å¦‚å¦‚æœæœ‰ ik æ’ä»¶ï¼Œé‚£ä¹ˆéœ€è¦ä¿è¯ ik çš„è¯å…¸æ–‡ä»¶ä¸è€é›†ç¾¤ä¸€è‡´&lt;/li&gt;
&lt;li&gt;æ–°å»ºç´¢å¼•ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯æ–¹ä¾¿åé¢çš„ç´¢å¼•èƒ½å¤ŸåŒæ­¥åŒå†™åˆ°æ–°è€ä¸¤ä¸ªé›†ç¾¤ã€‚åŒæ—¶å»ºç´¢å¼•æ—¶éœ€è¦æ³¨æ„ï¼Œes7 å·²ç»åºŸå¼ƒäº† mapping é‡Œçš„ document typeï¼Œmapping ä¸å†éœ€è¦æŒ‡å®š type äº†&lt;/li&gt;
&lt;li&gt;ç´¢å¼•åŒå†™ã€‚ç¬¬äºŒæ­¥å·²ç»å°†ç´¢å¼•åœ¨æ–°é›†ç¾¤ä¸­å»ºå¥½äº†ï¼Œè¿™é‡Œåœ¨ä¸šåŠ¡ä»£ç ä¸­å¼€å§‹åŒå†™ï¼Œä¿è¯æ–°å¢çš„ document èƒ½å¤Ÿä¸è€é›†ç¾¤çš„ç´¢å¼•ä¸€è‡´&lt;/li&gt;
&lt;li&gt;å…¨é‡ç´¢å¼•ã€‚æ–°å¢ç´¢å¼•ä¸€è‡´åï¼Œå­˜é‡çš„ document ä¹Ÿéœ€è¦ä¸€è‡´ï¼Œå› æ­¤éœ€è¦æŠŠå­˜é‡çš„ doc é‡æ–°å…¨éƒ¨å¯¼å…¥åˆ°æ–°é›†ç¾¤å†…ã€‚è¿™ä¸€æ­¥å®˜æ–¹æä¾›äº†ä¸€ä¸ª &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html#reindex-from-remote&#34;&gt;reindex from remote&lt;/a&gt;ï¼Œä½†æ˜¯å®é™…æ“ä½œåå‘ç°ï¼Œreindex åï¼Œmapping å’Œ settings ä¼šæœ‰å‡ºå…¥ï¼Œå¹¶ä¸”ä¸ç¡®å®šè¿™ä¸ªæ“ä½œå¯¹è€é›†ç¾¤çš„å‹åŠ›å¤§ä¸å¤§ï¼Œå› æ­¤è¿˜æ˜¯å†³å®šè·‘ä¸‹è„šæœ¬äººå·¥é‡å»º&lt;/li&gt;
&lt;li&gt;çº¿ä¸Šæµ‹è¯•ï¼ŒåŒ…æ‹¬æ€§èƒ½æµ‹è¯•ã€ç¨³å®šæ€§è§‚å¯Ÿã€æ•°æ®æ¯”å¯¹ç­‰&lt;/li&gt;
&lt;li&gt;åœæ‰ç´¢å¼•åŒå†™&lt;/li&gt;
&lt;li&gt;ä¸‹çº¿è€é›†ç¾¤ï¼Œå…¨é¢è¦†ç›–æ–°é›†ç¾¤&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;æµ‹è¯•æ–°é›†ç¾¤&#34;&gt;æµ‹è¯•æ–°é›†ç¾¤&lt;/h2&gt;
&lt;p&gt;æ–°é›†ç¾¤å‡†å¤‡å¥½ä¹‹åï¼Œéœ€è¦è¿›è¡Œä¸€äº›å¿…è¦çš„æµ‹è¯•ï¼Œæ¯”å¦‚ï¼šæ€§èƒ½æµ‹è¯•ã€æ•°æ®æ¯”å¯¹ã€è€çš„æŸ¥è¯¢è¯­å¥å…¼å®¹æ€§æµ‹è¯•ã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ€§èƒ½æµ‹è¯•&#34;&gt;æ€§èƒ½æµ‹è¯•&lt;/h4&gt;
&lt;p&gt;æ€§èƒ½æµ‹è¯•å¯ä»¥æŒ‘æ‹£ä¸€ä¸ªä¸šåŠ¡ä»£ç é‡Œæœ€å¸¸ç”¨çš„æŸ¥è¯¢è¯­å¥ï¼Œç„¶åè¿›è¡Œå‹æµ‹ã€‚æ¯”å¦‚æˆ‘è¿™é‡Œä½¿ç”¨ wrk å‹æµ‹ä¸€ä¸ªæœ€ç®€å•çš„å…¨æ–‡æœç´¢&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// dsl.lua æ–‡ä»¶å†…å®¹

wrk.method = &amp;quot;GET&amp;quot;
wrk.body = [[{
    &amp;quot;query&amp;quot;:{
        &amp;quot;match&amp;quot;:{
            &amp;quot;name&amp;quot;:{
                &amp;quot;query&amp;quot;:&amp;quot;çƒ˜ç„™&amp;quot;
            }
        }
    },
    &amp;quot;size&amp;quot;:100
}]]
wrk.headers[&amp;quot;Content-Type&amp;quot;] = &amp;quot;application/json&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‹æµ‹å‘½ä»¤ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;wrk -t10 -c10 -d10s --script=dsl.lua http://elasticsearch-address:9200/you_index/_search
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç»“æœç¤ºä¾‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Running 10s test @ http://elasticsearch-address:9200/you_index/_search
  10 threads and 10 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     8.31ms    2.12ms  35.71ms   75.93%
    Req/Sec   121.09     12.97   151.00     78.10%
  12068 requests in 10.01s, 3.80GB read
Requests/sec:   1205.70
Transfer/sec:    388.64MB
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥é€‚å½“è°ƒæ•´å‹æµ‹å‚æ•°ï¼Œä»¥åŠæŸ¥è¯¢è¯­å¥ï¼Œé€šè¿‡æ¯”å¯¹ wrk è¾“å‡ºçš„ Avg latency å¾—å‡ºæ€§èƒ½å·®å¼‚çš„ç»“è®ºã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ•°æ®æ¯”å¯¹&#34;&gt;æ•°æ®æ¯”å¯¹&lt;/h4&gt;
&lt;p&gt;ä¸æ€§èƒ½å‹æµ‹ç±»ä¼¼ï¼Œæ‰¾ä¸€äº›ä¸šåŠ¡å¸¸ç”¨çš„æŸ¥è¯¢è¯­å¥ï¼Œåˆ†åˆ«å¯¹ä¸¤ä¸ªé›†ç¾¤æŸ¥è¯¢ç»“æœé‡‡æ ·ï¼Œæ¯”å¯¹æœå‡ºæ¥çš„ç»“æœæ˜¯å¦æœ‰å·®å¼‚ï¼Œä¾æ¬¡åˆ¤æ–­ç´¢å¼•æ˜¯å¦æœ‰å·®å¼‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸šåŠ¡æ•°æ®æµ‹è¯•çš„åŒæ—¶ï¼Œè¿˜éœ€è¦æµ‹è¯•æ’ä»¶åŠ è½½æ˜¯å¦ä¸è€é›†ç¾¤ä¸€è‡´ï¼Œæ¯”å¦‚ ik çš„è¯å…¸æ–‡ä»¶æ˜¯å¦æ­£å¸¸åŠ è½½ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-analyze.html&#34;&gt;&lt;code&gt;/index/_analyze&lt;/code&gt;&lt;/a&gt; æ¥å£æ¥è¿›è¡Œæµ‹è¯•ï¼Œå¹¶æ¯”å¯¹ç»“æœæ˜¯å¦ä¸€è‡´&lt;/p&gt;
&lt;h4 id=&#34;è¯¡å¼‚çš„æ¯›åˆº&#34;&gt;è¯¡å¼‚çš„æ¯›åˆº&lt;/h4&gt;
&lt;p&gt;åœ¨å°†ç´¢å¼•è¿ç§»åˆ°æ–°é›†ç¾¤åï¼Œæ€§èƒ½ç›‘æ§å‘ç°ï¼Œ æœç´¢è¯·æ±‚ç»å¸¸æ€§çš„å‡ºç°æ¯›åˆºï¼Œè€Œä¸”çœ‹èµ·æ¥æ˜¯æœ‰è§„å¾‹çš„æ¯›åˆºï¼Œå¦‚æœ 30s å†…æ²¡æœ‰ search è¯·æ±‚ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å¿…ç„¶ä¼šå‡ºç°ä¸€æ ¹æ¯›åˆº
&lt;img src=&#34;https://when.run/image/es_latency.png&#34; alt=&#34;es-latency&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªé—®é¢˜å›°æ‰°äº†å¾ˆä¹…ï¼Œæ’æŸ¥æ€è·¯å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;é¦–å…ˆæŸ¥çœ‹æ˜¯å¦ä¸º SDK çš„é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯å®¢æˆ·ç«¯åˆ° es server çš„é•¿è¿æ¥æ–­äº†ï¼Œå¯¼è‡´ 30s åéœ€è¦é‡æ–°å»ºç«‹é•¿è¿æ¥ï¼Œè°ƒé•¿é“¾æ¥æ—¶é—´åå‘ç°å¹¶æœªæ”¹å–„&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ¥ä¸‹æ¥çœ‹ç´¢å¼•çš„ &lt;code&gt;_stats&lt;/code&gt; ä¿¡æ¯ï¼Œå‘ç° &lt;code&gt;docs.deleted&lt;/code&gt; ç‰¹åˆ«å¤šã€‚äº§ç”Ÿè¿™ä¹ˆå¤š deleted çš„åŸå› å¯ä»¥è§£é‡Šï¼Œå› ä¸ºä¸€ä¸ª update æ“ä½œç­‰äºä¸€ä¸ª create + ä¸€ä¸ª deleteï¼Œåˆ›å»ºæ–° docï¼Œæ ‡è®°è€ doc ä¸º deletedã€‚ä½†æ˜¯åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œmerge ä¼šæŠŠè€çš„ segment ç»™åˆå¹¶æ‰ï¼Œdeleted çš„ doc ä¹Ÿä¸€å¹¶è¢«æ¸…ç†äº†ï¼Œä½†æ˜¯è¿™ä¸ªæŒ‡æ ‡å´æ²¡æœ‰è§å˜å°‘ï¼Œä¸€ç›´åœ¨å¢åŠ ï¼Œæ­¤æ—¶æ€€ç–‘æ˜¯ merge æµç¨‹çš„é—®é¢˜ã€‚æ˜¯å¦ merge æœªæ­£å¸¸å·¥ä½œã€‚
&lt;img src=&#34;https://when.run/image/docs_deleted.png&#34; alt=&#34;docs.deleted&#34;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç»§ç»­çœ‹ç´¢å¼•çš„ &lt;code&gt;_stats&lt;/code&gt; ä¿¡æ¯ï¼Œå‘ç° &lt;code&gt;refresh&lt;/code&gt; æ•°éå¸¸å¥‡æ€ªï¼Œé»˜è®¤ &lt;code&gt;refresh_interval&lt;/code&gt; æ˜¯ 1sï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹æ˜¯æ¯ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œrefresh.total ä¹Ÿå°±æ˜¯ç´¢å¼•åˆ›å»ºåˆ°å½“å‰æ—¶é—´çš„ç§’æ•°ï¼Œè€Œå‡ å¤©å‰åˆ›å»ºçš„ç´¢å¼•ï¼Œç°åœ¨å´åª refresh äº†800+æ¬¡ï¼Œé‚£ä¹ˆæ˜¯å¦è·Ÿè¿™ä¸ªæ²¡æœ‰ refresh æœ‰å…³ç³»å‘¢ï¼Ÿä¸ºäº†éªŒè¯è¿™ä¸ªé—®é¢˜ï¼Œæ‰‹åŠ¨è·‘ä¸ªè„šæœ¬ï¼Œåœ¨åå°ä¸é—´æ–­çš„å‘é€ search è¯·æ±‚ï¼Œå‘ç°å¼€å§‹ refresh äº†ï¼Œæ¯›åˆºä¹Ÿæ¶ˆå¤±äº†ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨äº† refresh ä¸Šé¢ï¼Œå‡ºäºæŸäº›åŸå› æ²¡æœ‰æ­£å¸¸çš„æ‰§è¡Œ refresh
&lt;img src=&#34;https://when.run/image/refresh_total.png&#34; alt=&#34;refresh.total&#34;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;åœ¨ä¸€ç•ªæŸ¥æ‰¾ä¹‹åï¼Œåœ¨ &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#index-refresh-interval-setting&#34;&gt;es æ–‡æ¡£&lt;/a&gt; çš„ &lt;code&gt;refresh_interval&lt;/code&gt; å­—æ®µè§£é‡Šé‡Œå‘ç°è¿™ä¹ˆä¸€å¥è¯ï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºçš„æŒ‡å®š &lt;code&gt;refresh_interval&lt;/code&gt;ï¼Œé‚£ä¹ˆå¦‚æœ 30s å†…æ²¡æœ‰ search è¯·æ±‚æ¥ï¼Œä¼šè·³è¿‡ refresh æ­¥éª¤ï¼Œç›´åˆ°æœ‰ search è¯·æ±‚æ¥æ—¶ï¼Œæ‰ä¼šè§¦å‘ refreshï¼Œå¹¶ç­‰ refresh å®Œä¹‹åæ‰å¼€å§‹å¤„ç† search è¯·æ±‚ã€‚è¿™ä¹Ÿå°±èƒ½è§£é‡Šä¸ºä»€ä¹ˆ 30s æ²¡æœ‰æœç´¢æµé‡å°±ä¼šå‡ºç°ä¸€æ ¹æ¯›åˆºäº†ã€‚å½“æ‰‹åŠ¨ç»™ç´¢å¼•æŒ‡å®š &lt;code&gt;refresh_interval&lt;/code&gt; ä¹‹åï¼Œé»˜è®¤è¡Œä¸ºå°±å˜å¾—å’Œè€ç‰ˆæœ¬ä¸€æ ·ï¼Œä¸å†è·³è¿‡ refreshï¼Œæ¯›åˆºä¹Ÿå°±æ¶ˆå¤±äº†ã€‚åœ¨ elasticsearch 7.0 çš„ &lt;a href=&#34;https://www.elastic.co/cn/blog/elasticsearch-7-0-0-released&#34;&gt;release note&lt;/a&gt; é‡Œä¹Ÿæåˆ°äº†ï¼š
&lt;img src=&#34;https://when.run/image/refresh_interval_doc.png&#34; alt=&#34;refresh.doc&#34;&gt;
&lt;img src=&#34;https://when.run/image/es7_release.png&#34; alt=&#34;release&#34;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;å…¼å®¹æ€§æµ‹è¯•&#34;&gt;å…¼å®¹æ€§æµ‹è¯•&lt;/h4&gt;
&lt;p&gt;ç”±äºä¸¤ä¸ªé›†ç¾¤ç‰ˆæœ¬è·¨åº¦æ¯”è¾ƒå¤§ï¼Œå®¹æ˜“å‡ºä¹Œé¾™ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ª DSLï¼Œåœ¨ es 5.x å’Œ es7.x ä¸¤ä¸ªç‰ˆæœ¬çš„æœç´¢ç»“æœè¿¥ç„¶ä¸åŒã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;query&amp;quot;: {
    &amp;quot;bool&amp;quot; : {
      &amp;quot;should&amp;quot; : [
        { &amp;quot;term&amp;quot; : { &amp;quot;tags&amp;quot; : &amp;quot;env1&amp;quot; } },
        { &amp;quot;term&amp;quot; : { &amp;quot;tags&amp;quot; : &amp;quot;deployed&amp;quot; } }
      ]
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;åŸå› ä¸ºï¼šes5 bool query åªæœ‰ should æ¡ä»¶æ—¶ï¼Œé»˜è®¤ &lt;code&gt;minimum_should_match = 1&lt;/code&gt;ï¼Œè€Œåˆ°äº† es7 é‡Œï¼Œé»˜è®¤å€¼ä¸º 0 äº†ï¼Œå¯¼è‡´ es7 é‡Œæœå‡ºæ¥çš„æ˜¯å…¨éƒ¨ docï¼Œè€Œ es5 åªä¼šæœå‡ºç¬¦åˆæ¡ä»¶çš„ç»“æœ(&lt;a href=&#34;https://stackoverflow.com/questions/48984706/default-value-of-minimum-should-match/49012705#49012705&#34;&gt;default value of minimum should match&lt;/a&gt;ã€‚å¯¹äºè¿™äº›å·®å¼‚ï¼Œå¯ä»¥äº‹å…ˆé˜…è¯» &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html&#34;&gt;breaking changes 7.0&lt;/a&gt;ï¼Œå¹¶è¿›è¡Œç›¸åº”ä¿®æ”¹ã€‚å¯¹äºæœ‰ä¸å…¼å®¹æˆ–è€…æœ‰å·®å¼‚çš„è¯­å¥ï¼Œåœ¨ &lt;em&gt;æ•°æ®æ¯”å¯¹&lt;/em&gt; æ­¥éª¤ä¹Ÿèƒ½å¤Ÿæµ‹å‡ºæ¥ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åè®°&#34;&gt;åè®°&lt;/h2&gt;
&lt;p&gt;åœ¨æµ‹è¯•é€šè¿‡ä¹‹åï¼Œå°±å¯ä»¥ä¸‹çº¿è€é›†ç¾¤ï¼Œå…¨é¢åˆ‡æ¢åˆ°æ–°é›†ç¾¤äº†ğŸ‰ã€‚&lt;/p&gt;
&lt;p&gt;è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæœ‰å‡ ä¸ªè¸©è¿‡çš„å‘éœ€è¦æ³¨æ„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;es 7 å·²ç»åºŸå¼ƒäº† mapping type: &lt;a href=&#34;https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html&#34;&gt;Removal of mapping types&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åˆ‡è¯æ’ä»¶(ik) ç»“æœæ¯”å¯¹ï¼Œä¿è¯æ’ä»¶åŠ è½½æ­£å¸¸&lt;/li&gt;
&lt;li&gt;å…³æ³¨æ–°ç‰ˆæœ¬çš„ä¸€äº›é»˜è®¤å€¼æ”¹åŠ¨ï¼Œä¸€äº› breaking changes&lt;/li&gt;
&lt;/ul&gt;
</content>
    </item>
    
    <item>
      <title>Elasticsearch terminology: Index &amp; Shard &amp; Segment</title>
      <link>https://when.run/posts/es-terminology/</link>
      <pubDate>Wed, 04 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>https://when.run/posts/es-terminology/</guid>
      <description>References from https://stackoverflow.com/a/15429578
To explain:
Index An &amp;ldquo;index&amp;rdquo; in Elasticsearch is a bit like a database in a relational DB. It&amp;rsquo;s where you store/index your data. But actually, that&amp;rsquo;s just what your application sees. Internally, an index is a logical namespace that points to one or more shards.
Also, &amp;ldquo;to index&amp;rdquo; means to &amp;ldquo;put&amp;rdquo; your data into Elasticsearch. Your data is both stored (for retrieval) and &amp;ldquo;indexed&amp;rdquo; for search.
Inverted Index An &amp;ldquo;inverted index&amp;rdquo; is the data structure that Lucene uses to make data searchable.</description>
      <content>&lt;p&gt;&lt;em&gt;&lt;strong&gt;References from &lt;a href=&#34;https://stackoverflow.com/a/15429578&#34;&gt;https://stackoverflow.com/a/15429578&lt;/a&gt;&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;To explain:&lt;/p&gt;
&lt;h2 id=&#34;index&#34;&gt;Index&lt;/h2&gt;
&lt;p&gt;An &amp;ldquo;index&amp;rdquo; in Elasticsearch is a bit like a database in a relational DB. It&amp;rsquo;s where you store/index your data. But actually, that&amp;rsquo;s just what your application sees. Internally, an index is a logical namespace that points to one or more shards.&lt;/p&gt;
&lt;p&gt;Also, &amp;ldquo;to index&amp;rdquo; means to &amp;ldquo;put&amp;rdquo; your data into Elasticsearch. Your data is both stored (for retrieval) and &amp;ldquo;indexed&amp;rdquo; for search.&lt;/p&gt;
&lt;h2 id=&#34;inverted-index&#34;&gt;Inverted Index&lt;/h2&gt;
&lt;p&gt;An &amp;ldquo;inverted index&amp;rdquo; is the data structure that Lucene uses to make data searchable. It processes the data, pulls out unique terms or tokens, then records which documents contain those tokens. See &lt;a href=&#34;http://en.wikipedia.org/wiki/Inverted_index&#34;&gt;http://en.wikipedia.org/wiki/Inverted_index&lt;/a&gt; for more.&lt;/p&gt;
&lt;h2 id=&#34;shard&#34;&gt;Shard&lt;/h2&gt;
&lt;p&gt;A &amp;ldquo;shard&amp;rdquo; is an instance of Lucene. It is a fully functional search engine in its own right. An &amp;ldquo;index&amp;rdquo; could consist of a single shard, but generally consists of several shards, to allow the index to grow and to be split over several machines.&lt;/p&gt;
&lt;p&gt;A &amp;ldquo;primary shard&amp;rdquo; is the main home for a document. A &amp;ldquo;replica shard&amp;rdquo; is a copy of the primary shard that provides (1) failover in case the primary dies and (2) increased read throughput&lt;/p&gt;
&lt;h2 id=&#34;segment&#34;&gt;Segment&lt;/h2&gt;
&lt;p&gt;Each shard contains multiple &amp;ldquo;segments&amp;rdquo;, where a segment is an inverted index. A search in a shard will search each segment in turn, then combine their results into the final results for that shard.&lt;/p&gt;
&lt;p&gt;While you are indexing documents, Elasticsearch collects them in memory (and in the transaction log, for safety) then every second or so, writes a new small segment to disk, and &amp;ldquo;refreshes&amp;rdquo; the search.&lt;/p&gt;
&lt;p&gt;This makes the data in the new segment visible to search (ie they are &amp;ldquo;searchable&amp;rdquo;), but the segment has not been fsync&amp;rsquo;ed to disk, so is still at risk of data loss.&lt;/p&gt;
&lt;p&gt;Every so often, Elasticsearch will &amp;ldquo;flush&amp;rdquo;, which means fsync&amp;rsquo;ing the segments, (they are now &amp;ldquo;committed&amp;rdquo;) and clearing out the transaction log, which is no longer needed because we know that the new data has been written to disk.&lt;/p&gt;
&lt;p&gt;The more segments there are, the longer each search takes. So Elasticsearch will merge a number of segments of a similar size (&amp;ldquo;tier&amp;rdquo;) into a single bigger segment, through a background merge process. Once the new bigger segment is written, the old segments are dropped. This process is repeated on the bigger segments when there are too many of the same size.&lt;/p&gt;
&lt;p&gt;Segments are immutable. When a document is updated, it actually just marks the old document as deleted, and indexes a new document. The merge process also expunges these old deleted documents.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;References from &lt;a href=&#34;https://stackoverflow.com/a/15429578&#34;&gt;https://stackoverflow.com/a/15429578&lt;/a&gt;&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
