<!DOCTYPE html>
<html lang="cn">
<head>
  
    <title>Python2 迁移到 Python3 小事记 :: 重案组之虎</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="前期规划 在开始迁移前，需要大致盘点一下都会有哪些工作量，哪些代码需要做兼容，哪些服务需要做迁移。前期可以大概分成一下几部分：
 主项目（主要的项目，承担了主要的日常开发任务以及业务需求） 其他服务（为主项目服务的各个服务，如支付、IM、广告等） 依赖库，依赖又包括：  公司内部基础组件 第三方依赖   在列出所有的 &amp;ldquo;代码清单&amp;rdquo; 后，需要有个先后顺序，来逐步的进行迁移。首先上面提到的三个大点中，其他服务 其实优先级并不高，因为日常不怎么会开发，处于维护状态。因此保持正常运行即可，优先进行其他两项的迁移。而依赖库处处在引用，不提前进行 Python3 适配其他工作将无法进行。因此适配顺序如下：
 排查第三方依赖库，测试，升级到兼容 Python2/Python3 的版本 排查公司内部基础组件库，测试，兼容适配 Python2/Python3 进行主项目的代码层面适配，使用工具和一些库进行 2 和 3 的适配，使现有代码能同时在 2 和 3 下面跑。增加 py3 环境的单元测试。  在一切开始之前，还需要保证日常新加的代码不再引入不兼容的代码，因此应该提前使用 pre-commit 对每个 commit 进行检查，使用 pylint 进行兼容性检查，配置如下：
# .pre-commit-config.yaml - repo: https://github.com/xiachufang/mirrors-pylint rev: v1.9.2 hooks: - id: pylint args: - --py3k - --score=n  迁移中 迁移办法一般是先排查关键字，如 iteritems/itervalues/xrange 等，这些可以全部使用 six 相应方法直接替换。 除此之外，应该给单元测试增加 Python3 环境，这样首先保证单元测试能在 Python3 下跑通，在调通单元测试之后，如果测试覆盖率高，那么基本已经改完很大一部分代码了。在给代码做适配是，可以使用 futurize 来自动修改一些代码，减少一些重复工作。并且可以参考 futurize 的 Cheat Sheet: Writing Python 2-3 compatible code 来做对照，进行修改代码。"/>
<meta name="keywords" content="Python"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://when.run/posts/python2-to-python3/" />


<link rel="stylesheet" href="https://when.run/assets/style.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://when.run/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://when.run/avator.jpeg">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Python2 迁移到 Python3 小事记 :: 重案组之虎 — " />
<meta name="twitter:description" content="前期规划 在开始迁移前，需要大致盘点一下都会有哪些工作量，哪些代码需要做兼容，哪些服务需要做迁移。前期可以大概分成一下几部分：
 主项目（主要的项目，承担了主要的日常开发任务以及业务需求） 其他服务（为主项目服务的各个服务，如支付、IM、广告等） 依赖库，依赖又包括：  公司内部基础组件 第三方依赖   在列出所有的 &amp;ldquo;代码清单&amp;rdquo; 后，需要有个先后顺序，来逐步的进行迁移。首先上面提到的三个大点中，其他服务 其实优先级并不高，因为日常不怎么会开发，处于维护状态。因此保持正常运行即可，优先进行其他两项的迁移。而依赖库处处在引用，不提前进行 Python3 适配其他工作将无法进行。因此适配顺序如下：
 排查第三方依赖库，测试，升级到兼容 Python2/Python3 的版本 排查公司内部基础组件库，测试，兼容适配 Python2/Python3 进行主项目的代码层面适配，使用工具和一些库进行 2 和 3 的适配，使现有代码能同时在 2 和 3 下面跑。增加 py3 环境的单元测试。  在一切开始之前，还需要保证日常新加的代码不再引入不兼容的代码，因此应该提前使用 pre-commit 对每个 commit 进行检查，使用 pylint 进行兼容性检查，配置如下：
# .pre-commit-config.yaml - repo: https://github.com/xiachufang/mirrors-pylint rev: v1.9.2 hooks: - id: pylint args: - --py3k - --score=n  迁移中 迁移办法一般是先排查关键字，如 iteritems/itervalues/xrange 等，这些可以全部使用 six 相应方法直接替换。 除此之外，应该给单元测试增加 Python3 环境，这样首先保证单元测试能在 Python3 下跑通，在调通单元测试之后，如果测试覆盖率高，那么基本已经改完很大一部分代码了。在给代码做适配是，可以使用 futurize 来自动修改一些代码，减少一些重复工作。并且可以参考 futurize 的 Cheat Sheet: Writing Python 2-3 compatible code 来做对照，进行修改代码。" />
<meta name="twitter:site" content="https://when.run" />
<meta name="twitter:creator" content="x1ah" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="cn" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Python2 迁移到 Python3 小事记 :: 重案组之虎 — ">
<meta property="og:description" content="前期规划 在开始迁移前，需要大致盘点一下都会有哪些工作量，哪些代码需要做兼容，哪些服务需要做迁移。前期可以大概分成一下几部分：
 主项目（主要的项目，承担了主要的日常开发任务以及业务需求） 其他服务（为主项目服务的各个服务，如支付、IM、广告等） 依赖库，依赖又包括：  公司内部基础组件 第三方依赖   在列出所有的 &amp;ldquo;代码清单&amp;rdquo; 后，需要有个先后顺序，来逐步的进行迁移。首先上面提到的三个大点中，其他服务 其实优先级并不高，因为日常不怎么会开发，处于维护状态。因此保持正常运行即可，优先进行其他两项的迁移。而依赖库处处在引用，不提前进行 Python3 适配其他工作将无法进行。因此适配顺序如下：
 排查第三方依赖库，测试，升级到兼容 Python2/Python3 的版本 排查公司内部基础组件库，测试，兼容适配 Python2/Python3 进行主项目的代码层面适配，使用工具和一些库进行 2 和 3 的适配，使现有代码能同时在 2 和 3 下面跑。增加 py3 环境的单元测试。  在一切开始之前，还需要保证日常新加的代码不再引入不兼容的代码，因此应该提前使用 pre-commit 对每个 commit 进行检查，使用 pylint 进行兼容性检查，配置如下：
# .pre-commit-config.yaml - repo: https://github.com/xiachufang/mirrors-pylint rev: v1.9.2 hooks: - id: pylint args: - --py3k - --score=n  迁移中 迁移办法一般是先排查关键字，如 iteritems/itervalues/xrange 等，这些可以全部使用 six 相应方法直接替换。 除此之外，应该给单元测试增加 Python3 环境，这样首先保证单元测试能在 Python3 下跑通，在调通单元测试之后，如果测试覆盖率高，那么基本已经改完很大一部分代码了。在给代码做适配是，可以使用 futurize 来自动修改一些代码，减少一些重复工作。并且可以参考 futurize 的 Cheat Sheet: Writing Python 2-3 compatible code 来做对照，进行修改代码。" />
<meta property="og:url" content="https://when.run/posts/python2-to-python3/" />
<meta property="og:site_name" content="Python2 迁移到 Python3 小事记" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-11-12 00:00:00 &#43;0000 UTC" />











</head>
<body class="">


<div class="container full">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    重案组之虎罢了
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/collects/"> 收藏夹</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about/">About</a></li>
      
    
      
        <li><a href="/collects/"> 收藏夹</a></li>
      
    
      
        <li><a href="/index.xml">RSS</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://when.run/posts/python2-to-python3/">Python2 迁移到 Python3 小事记</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2019-11-12
    </span>
    
    
    <span class="post-author">::
      x1ah
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://when.run/tags/python/">Python</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    

<h2 id="前期规划">前期规划</h2>

<p>在开始迁移前，需要大致盘点一下都会有哪些工作量，哪些代码需要做兼容，哪些服务需要做迁移。前期可以大概分成一下几部分：</p>

<ul>
<li>主项目（主要的项目，承担了主要的日常开发任务以及业务需求）</li>
<li>其他服务（为主项目服务的各个服务，如支付、IM、广告等）</li>
<li>依赖库，依赖又包括：

<ul>
<li>公司内部基础组件</li>
<li>第三方依赖</li>
</ul></li>
</ul>

<p>在列出所有的 &ldquo;代码清单&rdquo; 后，需要有个先后顺序，来逐步的进行迁移。首先上面提到的三个大点中，<strong>其他服务</strong> 其实优先级并不高，因为日常不怎么会开发，处于维护状态。因此保持正常运行即可，优先进行其他两项的迁移。而依赖库处处在引用，不提前进行 Python3 适配其他工作将无法进行。因此适配顺序如下：</p>

<ol>
<li>排查第三方依赖库，测试，升级到兼容 Python2/Python3 的版本</li>
<li>排查公司内部基础组件库，测试，兼容适配 Python2/Python3</li>
<li>进行主项目的代码层面适配，使用工具和一些库进行 2 和 3 的适配，使现有代码能同时在 2 和 3 下面跑。增加 py3 环境的单元测试。</li>
</ol>

<p>在一切开始之前，还需要保证日常新加的代码不再引入不兼容的代码，因此应该提前使用 <a href="https://pre-commit.com/">pre-commit</a> 对每个 commit 进行检查，使用 <a href="https://github.com/pycqa/pylint">pylint</a> 进行兼容性检查，配置如下：</p>

<pre><code class="language-shell"># .pre-commit-config.yaml

-   repo: https://github.com/xiachufang/mirrors-pylint
    rev: v1.9.2
    hooks:
    -   id: pylint
        args:
          - --py3k
          - --score=n
</code></pre>

<h2 id="迁移中">迁移中</h2>

<p>迁移办法一般是先排查关键字，如 <code>iteritems</code>/<code>itervalues</code>/<code>xrange</code> 等，这些可以全部使用 <a href="https://six.readthedocs.io/">six</a> 相应方法直接替换。 除此之外，应该给单元测试增加 Python3 环境，这样首先保证单元测试能在 Python3 下跑通，在调通单元测试之后，如果测试覆盖率高，那么基本已经改完很大一部分代码了。在给代码做适配是，可以使用 <a href="http://python-future.org/index.html">futurize</a> 来自动修改一些代码，减少一些重复工作。并且可以参考 futurize 的 <a href="http://python-future.org/compatible_idioms.html">Cheat Sheet: Writing Python 2-3 compatible code</a> 来做对照，进行修改代码。</p>

<h3 id="会遇到的问题">会遇到的问题</h3>

<h4 id="关键字-方法">关键字/方法</h4>

<p>上面有提到，某些关键字或者方法，到了 Python3 里面已经没有了，比如 <code>xrange</code>/<code>dict.iteritems</code>/<code>dict.itervalues</code>，这个一般全局搜索就能排除掉。</p>

<h4 id="内置函数返回类型">内置函数返回类型</h4>

<ul>
<li>在 Python2 中，<code>dict.keys</code> 返回的是一个 list，而到了 Python3 中，返回的是一个 <code>dict_keys</code>，如果存在使用下标取，那么是会有问题的。如 <code>{&quot;K&quot;: &quot;V&quot;}.keys()[0]</code></li>
<li>Python2 中，map/reduce/filter 之类的关键字返回的是个 list，到了 3 中，返回的是 generator，如果需要下标访问是需要转成 list/tuple 的</li>
<li>etc&hellip;</li>
</ul>

<h3 id="str-bytes-unicode">str/bytes/unicode</h3>

<p>这个应当属迁移的最繁琐的地方。</p>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">其他文章</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      
      <span class="button next">
        <a href="https://when.run/posts/vector-clock/">
          <span class="button__text">向量时钟(Vector Clock)</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2019 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://when.run/assets/main.js"></script>
<script src="https://when.run/assets/prism.js"></script>





  
</div>

</body>
</html>
