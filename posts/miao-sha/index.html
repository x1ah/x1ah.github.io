<!doctype html><html lang=cn><head><title>如何设计一个秒杀系统 :: x1ah</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="总结极客时间专栏《如何设计一个秒杀系统》"><meta name=keywords content="秒杀,系统设计"><meta name=robots content="noodp"><link rel=canonical href=https://when.run/posts/miao-sha/><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://when.run/assets/style.css><link rel=apple-touch-icon href=https://when.run/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://when.run/avator.jpeg><meta name=twitter:card content="summary"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="og:title" content="如何设计一个秒杀系统"><meta property="og:description" content="总结极客时间专栏《如何设计一个秒杀系统》"><meta property="og:url" content="https://when.run/posts/miao-sha/"><meta property="og:site_name" content="x1ah"><meta property="og:image" content="https://when.run"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2019-10-02 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W",{anonymize_ip:!1})}</script></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>x1ah</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://when.run/posts/miao-sha/>如何设计一个秒杀系统</a></h1><div class=post-meta><span class=post-date>2019-10-02</span>
<span class=post-author>:: x1ah</span></div><span class=post-tags>#<a href=https://when.run/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/>系统设计</a>&nbsp;</span><div class=post-content><div><h1 id=如何设计一个秒杀系统>如何设计一个秒杀系统<a href=#如何设计一个秒杀系统 class=hanchor arialabel=Anchor>&#8983;</a></h1><blockquote><p>总结极客时间专栏《如何设计一个秒杀系统》</p></blockquote><p><a href=https://time.geekbang.org/column/127>极客时间</a></p><h1 id=问题>问题<a href=#问题 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>其实这类高并发问题，总结起来就是两点，<code>并发读</code>、 <code>并发写</code>。并且在这种情况下，系统还需要做到：</p><ul><li>高性能：支持并发读并发写</li><li>一致性：保证系统正确，如不发生超卖等</li><li>高可用：保证系统在极端条件下的可用性，PlanB 等</li></ul><hr><h1 id=原则>原则<a href=#原则 class=hanchor arialabel=Anchor>&#8983;</a></h1><ul><li>数据尽量少：c-s 传输过程中，数据尽量少，减少传输时间</li><li>请求数尽量少：减少资源消耗</li><li>路径尽量短：请求会经过若干个中间件，经过的中间件应该尽量少，每个节点都可能会挂，最后整体可用性(&lt;1)就是经过的所有节点可用性的乘积</li><li>依赖尽量少：指的是业务依赖（优惠券、用户信息等），防止主要服务被其他附属依赖给拖垮掉</li><li>不要有单点：单点就是整个系统中最弱的地方，很容易被击垮</li></ul><hr><h1 id=动静分离>动静分离<a href=#动静分离 class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=静态数据>静态数据<a href=#静态数据 class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>统一 cache 层</li><li>CDN</li><li>代理服务器缓存</li></ul><h2 id=动态数据>动态数据<a href=#动态数据 class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>业务隔离：必须参加活动需要提前报名，服务器对这些热点进行预热</li><li>系统隔离：秒杀系统单独部署，落到不同集群当中，避免拖垮其他服务</li><li>数据隔离：针对这些热点数据，比如启用单独的 cache 或 MySQL 实例</li></ul><hr><h1 id=流量削峰>流量削峰<a href=#流量削峰 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>面对秒杀系统需要承受的海量流量，如果全部落到数据库上，那么数据库将不堪重负，因此可以进行分层的流量削峰：</p><ul><li>答题、验证码等，在客户端直接过滤，将流量摊平，而不是瞬时洪峰流量</li><li>服务端请求排队，请求到达了不即时返回，而是塞进队列里，FIFO 方式进行处理，然后异步通知客户端（体验不好，用户无法实时收到反馈）</li><li>分层校验，保证落到数据库的请求都是有效请求</li></ul><p><img src=https://i.imgur.com/fb7F5UO.png alt></p><hr><h1 id=减库存>减库存<a href=#减库存 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>减库存是最关键的一个逻辑，需要保证高并发的情况下，不会发生超售。常用的有三种减库存方案：</p><ul><li>下单减库存：下单就减库存，会产生非常多无效订单，体验不好。</li><li>付款减库存：可能会有用户在付款完成之后，结果提示没库存了。</li><li>预扣库存：用户下单后减库存，但是库存只有几分钟有效期，过了有效期就回收库存，体验较好。</li></ul><hr><h1 id=planb>PlanB<a href=#planb class=hanchor arialabel=Anchor>&#8983;</a></h1><p>高可用系统的 PlanB，针对秒杀系统，可以做一些事，比如：</p><ul><li>降级：如系统容量到达一点程度之后，关闭一些非核心功能，把有限的资源让给核心功能</li><li>限流：在事先进行压力测试时，预估一个最高 QPS，并将其设为阈值，到达这个阈值之后，其他请求扔队列或者直接丢弃</li><li>拒绝服务：最坏的情况，达到某个临界点（CPU 90%）直接拒绝服务，保护服务，等负载下降之后恢复，避免被直接长时间拖垮。</li></ul><p><img src=https://i.imgur.com/vRlVzqW.png alt></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>其他文章</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://when.run/posts/vector-clock/><span class=button__icon>←</span>
<span class=button__text>向量时钟(Vector Clock)</span></a></span>
<span class="button next"><a href=https://when.run/posts/flask-extensions/><span class=button__text>如何开发 Flask 扩展</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=x1ah/x1ah.github.io issue-term=pathname label=Comment theme=photon-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://when.run/assets/main.js></script>
<script src=https://when.run/assets/prism.js></script></div></body></html>