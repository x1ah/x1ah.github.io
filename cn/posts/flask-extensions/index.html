<!doctype html><html lang=cn><head><title>å¦‚ä½•å¼€å‘ Flask æ‰©å±• :: x1ah</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å¦‚ä½•ç¼–å†™ Flask æ‰©å±•ï¼ŒFlask æ‰©å±•åŸç†ã€‚"><meta name=keywords content="Flask"><meta name=robots content="noodp"><link rel=canonical href=https://when.run/cn/posts/flask-extensions/><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W")}</script><link rel=stylesheet href=https://when.run/assets/style.css><link rel=apple-touch-icon href=https://when.run/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://when.run/avator.jpeg><meta name=twitter:card content="summary"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="og:title" content=" å¦‚ä½•å¼€å‘ Flask æ‰©å±•"><meta property="og:description" content="å¦‚ä½•ç¼–å†™ Flask æ‰©å±•ï¼ŒFlask æ‰©å±•åŸç†ã€‚"><meta property="og:url" content="https://when.run/cn/posts/flask-extensions/"><meta property="og:site_name" content="x1ah"><meta property="og:image" content="https://when.run/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2017-10-28 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W")}</script></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>x1ah</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/cn/about/>About</a></li><li><a href=/cn/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/cn/about/>About</a></li><li><a href=/cn/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://when.run/cn/posts/flask-extensions/>å¦‚ä½•å¼€å‘ Flask æ‰©å±•</a></h1><div class=post-meta><span class=post-date>2017-10-28
</span><span class=post-author>:: x1ah</span></div><span class=post-tags>#<a href=https://when.run/cn/tags/flask/>Flask</a>&nbsp;</span><div class=post-content><div><blockquote><p>å‡è®¾æˆ‘æ˜¯ä¸€ä¸ªæ¥å£è´©å­ï¼Œä¸“é—¨æä¾›å„ç§å„æ ·çš„ API ç»™æˆ‘çš„å®¢æˆ·ä»¬ï¼Œä¸»è¦è¿™äº› API åç«¯æ˜¯ç”¨ Python + Flask å®ç°çš„ã€‚æˆ‘éœ€è¦ç®¡ç†å’Œç›‘æ§æˆ‘çš„è¿™äº› API ä»¬ï¼Œçœ‹çœ‹å“ªäº›æ›´å—æ¬¢è¿ï¼Œå“ªäº›å“åº”æ…¢ï¼Œå“ªäº›éœ€è¦æ”¹è¿›ï¼Œäºæ˜¯æˆ‘æƒ³ç»™æˆ‘çš„åç«¯æœåŠ¡åšä¸ª Dashboardï¼Œèƒ½çœ‹åˆ°ä¸Šé¢é‚£äº›æ•°æ®ï¼Œå¹¶ä¸”æƒ³æŠŠè¿™ä¸ªä¸œè¥¿æŠ½è±¡å‡ºæ¥ï¼Œä»¥åæˆ‘è¿˜èƒ½å–å…¶ä»– APIï¼Œè¿˜èƒ½ç”¨åœ¨æˆ‘çš„å…¶ä»–é¡¹ç›®ä¸Šï¼Œäºæ˜¯ä¹æ‰“ç®—åšæˆä¸€ä¸ªæ’ä»¶ã€‚</p></blockquote><p>å…ˆå‡è£…æœ‰ä¸€ä¸ªå­˜æ•°æ®çš„å®¢æˆ·ç«¯ï¼ŒğŸ‘‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>APIDogClient</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;APIDog: æ”¶é›†æ¥å£æœåŠ¡çš„å„ç§ä¿¡æ¯ï¼Œè¯·æ±‚è€—æ—¶ï¼Œè¯·æ±‚è·¯å¾„ï¼Œè¯·æ±‚ IP ç­‰ç­‰ç­‰ç­‰&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, secret_key):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;x.x.x.x&#39;</span>   <span style=color:#75715e># å‡è£…æˆ‘æœ‰ä¸€äº›é…ç½®éœ€è¦åˆå§‹åŒ–</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;xxx&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>secret_key <span style=color:#f92672>=</span> secret_key
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>secret_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;xxx&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>bucket <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>storge</span>(self, data):
</span></span><span style=display:flex><span>        <span style=color:#75715e># clean data</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>bucket<span style=color:#f92672>.</span>append(data)
</span></span></code></pre></div><p>ç°åœ¨å¯ä»¥å¼€å§‹ç€æ‰‹æ’ä»¶äº†ï¼Œç»™æ’ä»¶å–åä¸º <code>flask-APIDog</code>ï¼Œç¬¬ä¸€ä»£æ‰“ç®—æ”¶é›†æ¯æ¬¡è¯·æ±‚çš„è·¯å¾„ï¼Œæ¯ä¸ªè¯·æ±‚çš„è€—æ—¶ï¼Œæ¯æ¬¡è¯·æ±‚çš„ IPã€‚æ¯æ¬¡è¯·æ±‚éƒ½è¿™äº›æ•°æ®ä¸€èµ·å‘é€åˆ°æˆ‘çš„ APIDog æœåŠ¡ç«¯å­˜èµ·æ¥ï¼Œå¹¶å±•ç¤ºåˆ° Dashboard ä¸Šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, request, current_app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> _app_ctx_stack <span style=color:#66d9ef>as</span> stack
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ImportError</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> _request_ctx_stack <span style=color:#66d9ef>as</span> stack
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>APIDog</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Flask-APIDog extendsion&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, app<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>app <span style=color:#f92672>=</span> app
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> app:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>init_app(app)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>api_dog <span style=color:#f92672>=</span> APIDogClient(self<span style=color:#f92672>.</span>app<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;api_dog_secret_key&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>init_app</span>(self, app<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>app <span style=color:#f92672>=</span> app
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>api_dog <span style=color:#f92672>=</span> APIDogClient(self<span style=color:#f92672>.</span>app<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;api_dog_secret_key&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>))
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span>before_request(self<span style=color:#f92672>.</span>_before_request)
</span></span><span style=display:flex><span>        app<span style=color:#f92672>.</span>after_request(self<span style=color:#f92672>.</span>_after_request)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_before_request</span>(self):
</span></span><span style=display:flex><span>        ctx <span style=color:#f92672>=</span> stack<span style=color:#f92672>.</span>top
</span></span><span style=display:flex><span>        ctx<span style=color:#f92672>.</span>_api_dog_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;request_begin_time&#39;</span>: time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_after_request</span>(self, response):
</span></span><span style=display:flex><span>        ctx <span style=color:#f92672>=</span> stack<span style=color:#f92672>.</span>top
</span></span><span style=display:flex><span>        api_request_begin_time <span style=color:#f92672>=</span> ctx<span style=color:#f92672>.</span>_api_dog_data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;request_path&#39;</span>, time<span style=color:#f92672>.</span>time())
</span></span><span style=display:flex><span>        request_time <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> api_request_begin_time
</span></span><span style=display:flex><span>        api_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;request_time&#39;</span>: request_time,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;request_path&#39;</span>: request<span style=color:#f92672>.</span>path,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;request_location&#39;</span>: request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;location&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;remote_address&#39;</span>: request<span style=color:#f92672>.</span>remote_addr
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>api_dog<span style=color:#f92672>.</span>storge(api_data)
</span></span></code></pre></div><p>ğŸ‘† æ˜¯ç¬¬ä¸€ç‰ˆçš„ <code>flask-APIDog</code> çš„ä»£ç ï¼Œå¾ˆç®€å•çš„ä¸€äº›å¤„ç†ï¼Œ Flask æ‰©å±•ä¸€èˆ¬ï¼ˆå®˜æ–¹å»ºè®®ï¼‰æä¾›ä¸€ä¸ª <code>init_app</code> æ–¹æ³•ï¼Œç”¨äºåœ¨å®ä¾‹åŒ–æ’ä»¶ç±»ååˆå§‹åŒ– Flask APPï¼Œå®é™…ä¸Šè¿™é‡Œåªæ˜¯ç®€å•çš„ç»™ Flask APP çš„ <code>before_request</code>ï¼Œ<code>after_request</code> ä¸¤ä¸ªé’©å­å‡½æ•°æä¾›ä¸¤ä¸ªå…·ä½“æµç¨‹ï¼Œ<code>_app_ctx_stack.top</code> æ˜¯ Flask
é‡Œé¢ä¸Šä¸‹æ–‡çš„æ¦‚å¿µï¼Œæ„æ€æ˜¯å–å½“å‰åº”ç”¨ã€‚æ›´ç”šè‡³å®Œå…¨å¯ä»¥ç›´æ¥ç”¨ <code>before_request</code>ï¼Œ<code>after_request</code> è£…é¥°ä¸¤ä¸ªå‡½æ•°æ¥å®ç°ä¸Šé¢é‚£äº›åŠŸèƒ½ï¼Œä½†æ˜¯åé¢è¿­ä»£ç‰ˆæœ¬ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œç›´æ¥å†™åœ¨é¡¹ç›®é‡Œå¾ˆå®¹æ˜“æ±¡æŸ“ç°æœ‰ä»£ç ï¼ŒæŠ½è±¡æˆæ’ä»¶ä¸ä»…æé«˜äº†é²æ£’æ€§ï¼Œè¿˜ç¬¦åˆ Flask çš„æ’ä»¶ç³»ç»Ÿç†å¿µã€‚</p><p>ä½¿ç”¨æ–¹æ³•ä¹Ÿä¸ä¸€èˆ¬çš„ Flask æ’ä»¶ä¸€è‡´ï¼ŒğŸ‘‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask_apidog <span style=color:#f92672>import</span> APIDog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(<span style=color:#e6db74>&#39;test_flask_extend&#39;</span>)
</span></span><span style=display:flex><span>api_dog <span style=color:#f92672>=</span> ApiDog()
</span></span><span style=display:flex><span>api_dog<span style=color:#f92672>.</span>init_app(app)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;hello api dog&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><p>è¿™æ ·ä¹‹åï¼ŒAPP çš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šè®°å½•è¯·æ±‚è€—æ—¶ï¼Œè¯·æ±‚ IPï¼Œè¯·æ±‚è·¯å¾„å¹¶è½¬å‘åˆ° APIDog åç«¯æœåŠ¡ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„ Flask æ’ä»¶å¤§è‡´å°±å®Œæˆäº†ã€‚</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>å…¶ä»–æ–‡ç« </span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://when.run/cn/posts/miao-sha/><span class=button__icon>â†</span>
<span class=button__text>å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ</span>
</a></span><span class="button next"><a href=https://when.run/cn/posts/python-interview/><span class=button__text>Python é¢è¯•é¢˜æ•´ç†[å®ä¹ ]</span>
<span class=button__icon>â†’</span></a></span></div></div><script src=https://utteranc.es/client.js repo=x1ah/x1ah.github.io issue-term=pathname label=Comment theme=photon-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://when.run/assets/main.js></script><script src=https://when.run/assets/prism.js></script></div></body></html>