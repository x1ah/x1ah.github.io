<!doctype html><html lang=cn><head><title>Python2 迁移到 Python3 规划和实施 :: x1ah</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="公司主项目的代码有七八年的历史，二三十万行的 Python2 代码，由于越来越多库不再支持 Python2，以及开发体验，一年前打算全面开启迁移工作，至今已经慢慢开始切分一些流量到 Python3 下了，这里记录迁移过程，以及遇到的一些坑。持续更新"><meta name=keywords content="Python"><meta name=robots content="noodp"><link rel=canonical href=https://when.run/cn/posts/python2-to-python3/><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://when.run/assets/style.css><link rel=apple-touch-icon href=https://when.run/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://when.run/avator.jpeg><meta name=twitter:card content="summary"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="og:title" content="Python2 迁移到 Python3 规划和实施"><meta property="og:description" content="公司主项目的代码有七八年的历史，二三十万行的 Python2 代码，由于越来越多库不再支持 Python2，以及开发体验，一年前打算全面开启迁移工作，至今已经慢慢开始切分一些流量到 Python3 下了，这里记录迁移过程，以及遇到的一些坑。持续更新"><meta property="og:url" content="https://when.run/cn/posts/python2-to-python3/"><meta property="og:site_name" content="x1ah"><meta property="og:image" content="https://when.run"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2019-11-12 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-21PQZQT56W"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-21PQZQT56W",{anonymize_ip:!1})}</script></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>x1ah</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://when.run/cn/posts/python2-to-python3/>Python2 迁移到 Python3 规划和实施</a></h1><div class=post-meta><span class=post-date>2019-11-12</span>
<span class=post-author>:: x1ah</span></div><span class=post-tags>#<a href=https://when.run/cn/tags/python/>Python</a>&nbsp;</span><div class=post-content><div><h2 id=前期规划>前期规划<a href=#前期规划 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>在开始迁移前，需要大致盘点一下都会有哪些工作量，哪些代码需要做兼容，哪些服务需要做迁移。前期可以大概分成一下几部分：</p><ul><li>主项目（主要的项目，承担了主要的日常开发任务以及业务需求）</li><li>其他服务（为主项目服务的各个服务，如支付、IM、广告等）</li><li>依赖库，依赖又包括：<ul><li>公司内部基础组件</li><li>第三方依赖</li></ul></li></ul><p>在列出所有的 &ldquo;代码清单&rdquo; 后，需要有个先后顺序，来逐步的进行迁移。首先上面提到的三个大点中，<strong>其他服务</strong> 其实优先级并不高，因为日常不怎么会开发，处于维护状态。因此保持正常运行即可，优先进行其他两项的迁移。而依赖库处处在引用，不提前进行 Python3 适配其他工作将无法进行。因此适配顺序如下：</p><ol><li>排查第三方依赖库，测试，升级到兼容 Python2/Python3 的版本</li><li>排查公司内部基础组件库，测试，兼容适配 Python2/Python3</li><li>进行主项目的代码层面适配，使用工具和一些库进行 2 和 3 的适配，使现有代码能同时在 2 和 3 下面跑。增加 py3 环境的单元测试。</li></ol><p>在一切开始之前，还需要保证日常新加的代码不再引入不兼容的代码，因此应该提前使用 <a href=https://pre-commit.com/>pre-commit</a> 对每个 commit 进行检查，使用 <a href=https://github.com/pycqa/pylint>pylint</a> 进行兼容性检查，配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># .pre-commit-config.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-   repo: https://github.com/xiachufang/mirrors-pylint
</span></span><span style=display:flex><span>    rev: v1.9.2
</span></span><span style=display:flex><span>    hooks:
</span></span><span style=display:flex><span>    -   id: pylint
</span></span><span style=display:flex><span>        args:
</span></span><span style=display:flex><span>          - --py3k
</span></span><span style=display:flex><span>          - --score<span style=color:#f92672>=</span>n
</span></span></code></pre></div><h2 id=迁移中>迁移中<a href=#迁移中 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>迁移办法一般是先排查关键字，如 <code>iteritems</code>/<code>itervalues</code>/<code>xrange</code> 等，这些可以全部使用 <a href=https://six.readthedocs.io/>six</a> 相应方法直接替换。 除此之外，应该给单元测试增加 Python3 环境，这样首先保证单元测试能在 Python3 下跑通，在调通单元测试之后，如果测试覆盖率高，那么基本已经改完很大一部分代码了。在给代码做适配是，可以使用 <a href=http://python-future.org/index.html>futurize</a> 来自动修改一些代码，减少一些重复工作。并且可以参考 futurize 的 <a href=http://python-future.org/compatible_idioms.html>Cheat Sheet: Writing Python 2-3 compatible code</a> 来做对照，进行修改代码。</p><h3 id=会遇到的问题>会遇到的问题<a href=#会遇到的问题 class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=关键字方法>关键字/方法<a href=#关键字方法 class=hanchor arialabel=Anchor>&#8983;</a></h4><p>上面有提到，某些关键字或者方法，到了 Python3 里面已经没有了，比如 <code>xrange</code>/<code>dict.iteritems</code>/<code>dict.itervalues</code>，这个一般全局搜索就能排除掉。</p><h4 id=内置函数返回类型>内置函数返回类型<a href=#内置函数返回类型 class=hanchor arialabel=Anchor>&#8983;</a></h4><ul><li>在 Python2 中，<code>dict.keys</code> 返回的是一个 list，而到了 Python3 中，返回的是一个 <code>dict_keys</code>，如果存在使用下标取，那么是会有问题的。如 <code>{"K": "V"}.keys()[0]</code></li><li>Python2 中，map/reduce/filter 之类的关键字返回的是个 list，到了 3 中，返回的是 generator，如果需要下标访问是需要转成 list/tuple 的</li><li>etc&mldr;</li></ul><h3 id=strbytesunicode>str/bytes/unicode<a href=#strbytesunicode class=hanchor arialabel=Anchor>&#8983;</a></h3><p>这个应当属迁移的最繁琐的地方。</p><p>中间遇到一次问题，排查了很久。代码库中有一个 <code>@cache</code> 装饰器，用来缓存函数返回值，在 py2 中有如下一段代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@cache</span>(<span style=color:#e6db74>&#39;cache_key&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;py2 返回结构&#34;</span>
</span></span></code></pre></div><p>cache 拿到函数返回值后，原样放进 Memcached，因为 Python2 中，str/bytes 实际上是不敏感的，甚至可以等同。该 <code>foo</code> 函数在 py2 下返回的是一个带 encoding 的 str，可以看做是 bytes 类型，这时候，如果在 py3 下把缓存结果取出来，那么将会是拿到一个 bytes 类型: <code>b"py2 返回结构"</code>，这里就很容易出错了，在 Python2 下时，这个和 str 一样，可以当做 str 处理，但是 Python3 必须正视类型，该用 str(text type) 就不能用 bytes。</p><h2 id=代码库迁移完成>代码库迁移完成<a href=#代码库迁移完成 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>把代码库全部兼容 Python2 和 Python3 之后，这时候代码库是可以同时在 Python2 和 Python3 上跑的，因此可以逐步开始切分流量，大概可以分成这么几个步骤：</p><ol><li>把 staging 流量复制到 Python3 的环境</li><li>部署 production 的 Python3 环境，并切分办公室流量至 Python3 环境</li><li>切分线上小部分流量到 Python3 环境，并逐步增加，直至全部覆盖</li></ol><h2 id=迁移后工作>迁移后工作<a href=#迁移后工作 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>全部迁移完成后，自然会给代码加上 type hint，前期可以使用 pre-commit 增加 mypy 类型检查，并且只检查改动到的文件。与此同时，使用 <a href=https://github.com/Instagram/MonkeyType>MonkeyType</a> 收集类型，自动添加一部分，减少工作量。</p><p>至此，迁移工作已经全部完成。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>其他文章</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://when.run/cn/posts/tcp/><span class=button__icon>←</span>
<span class=button__text>TCP 札记</span></a></span>
<span class="button next"><a href=https://when.run/cn/posts/vector-clock/><span class=button__text>向量时钟(Vector Clock)</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=x1ah/x1ah.github.io issue-term=pathname label=Comment theme=photon-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://when.run/assets/main.js></script>
<script src=https://when.run/assets/prism.js></script></div></body></html>